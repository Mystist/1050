define(["jquery","backbone","text!app/templates/song-template.html","helper","utils/utils","app/models/resource-model","app/views/resource-view","plupload/zh_CN","utils/config","bootstrap"],function(e,t,i,n,s,r,a,o,l){var c=t.View.extend({options:null,template:"#ShowSongTemplate",initialize:function(e){this.options=e||{},this.render()},render:function(){var t=_.template(e(i).find(this.template).html());this.$el.html(t(_.extend({},this,{app:this.options.app}))),e("#IndexContainer").empty().html(this.el)}}),d=t.View.extend({curPage:0,totalPage:0,pageSize:100,curSongsList:null,template:"#PagerTemplate",initialize:function(){this.initPager(),this.filterSongs(),this.render(),this.renderHtml()},initPager:function(){if(this.collection.length>0){this.curPage=1;var e=this.collection.length/this.pageSize;this.totalPage=e===parseInt(e,10)?e:parseInt(e,10)+1}},filterSongs:function(){var e=(this.curPage-1)*this.pageSize;this.curSongsList=_.filter(this.collection.toJSON(),function(t,i){return i>=e&&i<e+this.pageSize},this)},render:function(){e("#PagerContainer").empty().html(this.el)},renderHtml:function(){var t=this;require(["app/models/song-model"],function(n){var s=(new u({collection:new n.Songs(t.curSongsList)}),_.template(e(i).find(t.template).html()));t.$el.html(s(t))})},events:{"click .pagination a":"goto"},"goto":function(t){var i=e(t.currentTarget);switch(i.attr("tag")){case"prev":this.curPage-=1;break;case"next":this.curPage+=1;break;default:this.curPage=parseInt(i.html(),10)}this.filterSongs(),this.renderHtml()}}),u=t.View.extend({template:"#SongsTemplate",initialize:function(){this.render(),this.$el.popover({selector:'*[data-toggle="popover"]',placement:"left",html:!0})},render:function(){var t=_.template(e(i).find(this.template).html());this.$el.html(t(_.extend({},this,{config:l}))),e("#SongsContainer").empty().html(this.el)},events:{'click *[tag="play"]':"play"},play:function(t){var i=e(t.currentTarget).closest("*[song_id]").attr("song_id"),n=this.collection.get(i);(this.viewInUse||(this.viewInUse={}||this.viewInUse)).playerView&&this.viewInUse.playerView.close(),this.viewInUse.playerView=new p({model:n}),s.renderNowPlaying(e(t.currentTarget),"success")}}),p=t.View.extend({template:"#PlayerTemplate",initialize:function(){this.render()},render:function(){var t=_.template(e(i).find(this.template).html());this.$el.html(t(this)),e("#PlayerContainer").empty().html(this.el)},events:{'click *[tag="close"]':"close"},close:function(){this.clean(),this.remove()},clean:function(){var e=this.$("iframe");0!=e.length&&(e[0].src="",e[0].contentWindow.document.write(""),e[0].contentWindow.close(),e.remove()),"function"==typeof CollectGarbage&&CollectGarbage()}}),g=t.View.extend({uploadedResources:[],songResources:[],picResources:[],template:"#EditSongTemplate",initialize:function(){this.render(),this.model.id&&this.initResources();var e=this;setTimeout(function(){e.$el.tooltip({selector:'*[data-toggle="tooltip"]',placement:"right"}),e.initUploader("song"),e.initUploader("pic")},50)},render:function(){var t=_.template(e(i).find(this.template).html());this.$el.html(t(_.extend({},{model:this.model},{helper:n}))),e("#IndexContainer").empty().html(this.el)},events:{'click *[tag="submit"]':"submit",'dblclick *[tag="del"]':"del",'click *[tag="play"]':"play"},submit:function(t){var i=s.getObjFromForm(this.$el);i.resources=this.uploadedResources;var n=this.model,r=n.save(i,{wait:!0,$btn:e(t.currentTarget),success:function(e,t){if(t&&!t.error){require(["app"],function(e){e.router.navigate("#modification/"+n.id)});{new h.EditSongView({model:n})}}}}),a=this.$("select, input").closest(".form-group").find('*[tag="alert"]').children();if(a.remove(),!r){var o=0;_.each(n.validationError,function(t,i){var n=this.$('*[name="'+i+'"]').closest(".form-group").find('*[tag="alert"]').first(),r=e(s.getAlertHtml("alert-danger",t));s.renderAlert(n,r,6e4),0==o&&this.$('*[name="'+i+'"]').focus(),o++},this)}},del:function(t){this.model.destroy({wait:!0,$btn:e(t.currentTarget),success:function(e,t){t&&!t.error&&require(["app"],function(e){e.router.navigate("",{trigger:!0,replace:!0})})}})},initUploader:function(t){var r=this,a="",l="",c="",d={};if("song"==t&&(a=r.$('*[tag="song"]'),d={max_file_size:"10mb",mime_types:[{title:"Audio files",extensions:"mp3,mid,wma,wav,ogg"}]}),"pic"==t&&(a=r.$('*[tag="pic"]'),d={max_file_size:"10mb",mime_types:[{title:"Image files",extensions:"gif,jpg,jpeg,png"}]}),a){l=a.find('*[tag="upload"]'),c=a.find('*[tag="start_upload"]');var u=new o.Uploader({flash_swf_url:"/js/libs/plupload/Moxie.swf",runtimes:"flash",container:a[0],browse_button:l[0],url:"http://up.qiniu.com:80/",filters:d,multipart_params:{token:e("#IndexContainer").attr("token")},init:{PostInit:function(){c.bind("click",function(){return e(this).attr("disabled","disabled"),u.start(),!1})},FilesAdded:function(t,n){o.each(n,function(t){var n=_.template(e(i).find("#UploadTemplate").html()),s=e(n({file:t}));a.find('*[tag="upload_container"] tbody').append(s),s.find('*[tag="cancel_upload"]').bind("click",function(){u.removeFile(t),s.remove()}),t.$target=s}),c.show()},UploadProgress:function(e,t){var i=t.$target.find(".progress-bar"),n=t.percent;i.css("width",n+"%").attr("aria-valuenow",n).find("span").html(n+"%"),t.$target.find('*[tag="cancel_upload"]').attr("disabled","disabled")},Error:function(t,i){var n=e(s.getAlertHtml("alert-danger",i.message)),r=l.closest(".row").find('*[tag="alert"]').first();if(s.renderAlert(r,n,6500),i.file){var a={614:"文件名已存在"},o=a[i.status]?"（"+a[i.status]+"）":"（错误代码"+i.status+"）";i.file.$target.find(".progress-bar").find("span").html("上传失败"+o),i.file.$target.addClass("danger"),i.file.$target.find('*[tag="cancel_upload"]').removeAttr("disabled")}},BeforeUpload:function(e,t){e.settings.multipart_params.key=t.name},FileUploaded:function(e,i){i.$target.find(".progress-bar").find("span").html("上传成功"),i.$target.addClass("success"),i.$target.find('*[tag="cancel_upload"]').remove();var s={file_name:i.name,file_size:i.size,uploaded_time:n.formatDateTime(new Date,"second"),file_type:t};-1==_.indexOf(_.pluck(r.uploadedResources,"file_name"),s.file_name)&&r.uploadedResources.push(s)},UploadComplete:function(){c.removeAttr("disabled")}}});u.init()}},initResources:function(){var e=_.filter(this.model.get("resources"),function(e){return"song"==e.file_type});if(this.songResources=new r.Resources(e),this.songResources.length>0){new a.ResourcesView({collection:this.songResources,el:this.$("#SongResourcesContainer")})}var t=_.filter(this.model.get("resources"),function(e){return"pic"==e.file_type});if(this.picResources=new r.Resources(t),this.picResources.length>0){new a.ResourcesView({collection:this.picResources,el:this.$("#PicResourcesContainer")})}},play:function(t){var i=e(t.currentTarget).closest("*[resource_id]").attr("resource_id");this.model.set("song_src",this.songResources.get(i).get("file_name")),(this.viewInUse||(this.viewInUse={}||this.viewInUse)).playerView&&this.viewInUse.playerView.close(),this.viewInUse.playerView=new p({model:this.model}),s.renderNowPlaying(e(t.currentTarget),"success")}}),h={ShowSongView:c,PagerView:d,SongsView:u,EditSongView:g,PlayerView:p};return h});