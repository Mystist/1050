define(["jquery","backbone","text!app/templates/song-template.html","helper","utils/utils","plupload/zh_CN","app/models/resource-model","app/views/resource-view","utils/config"],function(e,t,n,r,i,s,o,u){var a=t.View.extend({template:"#ShowSongTemplate",initialize:function(){this.render()},render:function(){var t=_.template(e(n).find(this.template).html());this.$el.html(t(this)),e("#IndexContainer").empty().html(this.el)}}),f=t.View.extend({template:"#SongsTemplate",initialize:function(){this.render()},render:function(){var t=_.template(e(n).find(this.template).html());this.$el.html(t(this)),e("#SongsContainer").empty().html(this.el)},events:{'click *[tag="play"]':"play"},play:function(t){var n=e(t.currentTarget).closest("*[song_id]").attr("song_id"),r=this.collection.get(n),i=new l({model:r})}}),l=t.View.extend({audioInstance:null,template:"#PlayerTemplate",initialize:function(){this.render()},render:function(){var t=_.template(e(n).find(this.template).html());this.$el.html(t(this)),e("#PlayerContainer").empty().html(this.el)},events:{'click *[tag="close"]':"close"},close:function(){this.clean(),this.remove()},clean:function(){var e=this.$("iframe");e[0].src="",e[0].contentWindow.document.write(""),e[0].contentWindow.close(),e.remove(),typeof CollectGarbage=="function"&&CollectGarbage()}}),c=t.View.extend({options:{uploadedResources:[],songResources:[],picResources:[]},template:"#EditSongTemplate",initialize:function(){this.render(),this.$el.tooltip({selector:'*[data-toggle="tooltip"]',placement:"right"}),this.model.id&&this.initResources(),this.initUploader("song"),this.initUploader("pic")},render:function(){var t=_.template(e(n).find(this.template).html());this.$el.html(t(_.extend({},{model:this.model},{helper:r}))),e("#IndexContainer").empty().html(this.el)},events:{'click *[tag="submit"]':"submit",'dblclick *[tag="del"]':"del",'click *[tag="play"]':"play"},submit:function(t){var n=i.getObjFromForm(this.$el);n.resources=this.options.uploadedResources;var r=this.model,s=r.save(n,{wait:!0,$btn:e(t.currentTarget),success:function(e,t){if(t&&!t.error){require(["app"],function(e){e.router.navigate("#modification/"+r.id)});var n=new h.EditSongView({model:r})}}}),o=this.$("select, input").closest(".form-group").find('*[tag="alert"]').children();o.remove();if(!s){var u=0;_.each(r.validationError,function(t,n){var r=this.$('*[name="'+n+'"]').closest(".form-group").find('*[tag="alert"]').first(),s=e(i.getAlertHtml("alert-danger",t));i.renderAlert(r,s,6e4),u==0&&this.$('*[name="'+n+'"]').focus(),u++},this)}},del:function(t){this.model.destroy({wait:!0,$btn:e(t.currentTarget),success:function(e,t){t&&!t.error&&require(["app"],function(e){e.router.navigate("",{trigger:!0,replace:!0})})}})},initUploader:function(t){var o=this,u="",a="",f="",l={};t=="song"&&(u=o.$('*[tag="song"]'),l={max_file_size:"10mb",mime_types:[{title:"Audio files",extensions:"mp3,mid,wma,wav,ogg"}]}),t=="pic"&&(u=o.$('*[tag="pic"]'),l={max_file_size:"10mb",mime_types:[{title:"Image files",extensions:"gif,jpg,jpeg,png"}]});if(!u)return;a=u.find('*[tag="upload"]'),f=u.find('*[tag="start_upload"]');var c=new s.Uploader({flash_swf_url:"/js/libs/plupload/Moxie.swf",runtimes:"flash",container:u[0],browse_button:a[0],url:"http://up.qiniu.com:80/",filters:l,multipart_params:{token:e("#IndexContainer").attr("token")},init:{PostInit:function(){f.bind("click",function(){return e(this).attr("disabled","disabled"),c.start(),!1})},FilesAdded:function(t,r){s.each(r,function(t){var r=_.template(e(n).find("#UploadTemplate").html()),i=e(r({file:t}));u.find('*[tag="upload_container"] tbody').append(i),i.find('*[tag="cancel_upload"]').bind("click",function(){c.removeFile(t),i.remove()}),t.$target=i}),f.show()},UploadProgress:function(e,t){var n=t.$target.find(".progress-bar"),r=t.percent;n.css("width",r+"%").attr("aria-valuenow",r).find("span").html(r+"%"),t.$target.find('*[tag="cancel_upload"]').attr("disabled","disabled")},Error:function(t,n){var r=e(i.getAlertHtml("alert-danger",n.message)),s=a.closest(".row").find('*[tag="alert"]').first();i.renderAlert(s,r,6500);if(n.file){var o={614:"文件名已存在"},u=o[n.status]?"（"+o[n.status]+"）":"（错误代码"+n.status+"）";n.file.$target.find(".progress-bar").find("span").html("上传失败"+u),n.file.$target.addClass("danger"),n.file.$target.find('*[tag="cancel_upload"]').removeAttr("disabled")}},BeforeUpload:function(e,t){e.settings.multipart_params.key=t.name},FileUploaded:function(e,n){n.$target.find(".progress-bar").find("span").html("上传成功"),n.$target.addClass("success"),n.$target.find('*[tag="cancel_upload"]').remove();var i={file_name:n.name,file_size:n.size,uploaded_time:r.formatDateTime(new Date,"second"),file_type:t};_.indexOf(_.pluck(o.options.uploadedResources,"file_name"),i.file_name)==-1&&o.options.uploadedResources.push(i)},UploadComplete:function(e,t){f.removeAttr("disabled")}}});c.init()},initResources:function(){var e=_.filter(this.model.get("resources"),function(e){return e.file_type=="song"});this.options.songResources=new o.Resources(e);if(this.options.songResources.length>0)var t=new u.ResourcesView({collection:this.options.songResources,el:this.$("#SongResourcesContainer")});var n=_.filter(this.model.get("resources"),function(e){return e.file_type=="pic"});this.options.picResources=new o.Resources(n);if(this.options.picResources.length>0)var r=new u.ResourcesView({collection:this.options.picResources,el:this.$("#PicResourcesContainer")})},play:function(t){var n=e(t.currentTarget).closest("*[resource_id]").attr("resource_id");this.model.set("song_src",this.options.songResources.get(n).get("file_name")),(this.viewInUse||(this.viewInUse={}||this.viewInUse)).playerView&&this.viewInUse.playerView.close(),this.viewInUse.playerView=new l({model:this.model})}}),h={ShowSongView:a,SongsView:f,EditSongView:c,PlayerView:l};return h});