define(["jquery","backbone","text!app/templates/song-template.html","helper","utils/utils","app/models/resource-model","app/views/resource-view","app/models/meeting-model","plupload/zh_CN","utils/config","bootstrap","bootstrap-waterfall"],function(e,t,i,n,s,r,a,o,l,c){var d=t.View.extend({options:null,template:"#ShowSongTemplate",initialize:function(e){this.options=e||{},this.render()},render:function(){var t=_.template(e(i).find(this.template).html());this.$el.html(t(_.extend({},this,{app:this.options.app}))),e("#IndexContainer").empty().html(this.el)}}),p=t.View.extend({curPage:0,totalPage:0,pageSize:100,curSongsList:null,template:"#PagerTemplate",initialize:function(){this.initPager(),this.filterSongs(),this.render(),this.renderHtml()},initPager:function(){if(this.collection.length>0){this.curPage=1;var e=this.collection.length/this.pageSize;this.totalPage=e===parseInt(e,10)?e:parseInt(e,10)+1}},filterSongs:function(){var e=(this.curPage-1)*this.pageSize;this.curSongsList=_.filter(this.collection.toJSON(),function(t,i){return i>=e&&i<e+this.pageSize},this)},render:function(){e("#PagerContainer").empty().html(this.el)},renderHtml:function(){var t=this;require(["app/models/song-model"],function(n){var s=_.template(e(i).find(t.template).html());t.$el.html(s(t));new u({collection:new n.Songs(t.curSongsList)})})},events:{"click .pagination li:not(.disabled) a":"goto"},"goto":function(t){var i=e(t.currentTarget);switch(i.attr("tag")){case"prev":this.curPage-=1;break;case"next":this.curPage+=1;break;default:this.curPage=parseInt(i.text(),10)}this.filterSongs(),this.renderHtml()}}),u=t.View.extend({template:"#SongsTemplate",initialize:function(){this.render()},render:function(){var t=_.template(e(i).find(this.template).html());this.$el.html(t());var n=_.template(e(i).find('*[type="text/bootstrap-waterfall-template"]')[0].outerHTML);this.$el.append(n(_.extend({},this,{config:c},{userId:e("#IndexContainer").attr("user_id")}))),e("#SongsContainer").empty().html(this.el),this.$(".bootstrap-waterfall").waterfall()},events:{'click *[tag="play"]':"play",'click *[tag="add"]':"add"},play:function(t){var i=e(t.currentTarget).closest("*[song_id]").attr("song_id"),n=this.collection.get(i);(this.viewInUse||(this.viewInUse={})).playerView&&this.viewInUse.playerView.close(),this.viewInUse.playerView=new h({model:n}),this.renderNowPlaying(e(t.currentTarget),"btn-success")},renderNowPlaying:function(e,t){var i=e.closest("#SongsContainer");i.find("a."+t).removeClass(t),e.addClass(t)},add:function(t){var i=e(t.currentTarget).closest("*[song_id]").attr("song_id"),n=this.collection.get(i),s=new o.MeetingSong({song_id:n.id});s.save(null,{wait:!0,$btn:e(t.currentTarget)})}}),g=t.View.extend({options:null,tagName:"tr",template:"#SongTemplate",initialize:function(e){this.options=e||{},this.render()},render:function(){var t=_.template(e(i).find(this.template).html());this.$el.empty().html(t(this)),this.options.$target.append(this.el)},events:{'click *[tag="play"]':"play"},play:function(t){(this.viewInUse||(this.viewInUse={})).playerView&&this.viewInUse.playerView.close(),this.viewInUse.playerView=new h({model:this.model}),s.renderNowPlaying(e(t.currentTarget),"success")}}),h=t.View.extend({template:"#PlayerTemplate",initialize:function(){this.render()},render:function(){var t=_.template(e(i).find(this.template).html());this.$el.html(t(this)),e("#PlayerContainer").empty().html(this.el)},events:{'click *[tag="close"]':"close"},close:function(){this.clean(),this.remove()},clean:function(){var e=this.$("iframe");0!=e.length&&(e[0].src="",e[0].contentWindow.document.write(""),e[0].contentWindow.close(),e.remove()),"function"==typeof CollectGarbage&&CollectGarbage()}}),m=t.View.extend({uploadedResources:[],songResources:[],picResources:[],template:"#EditSongTemplate",initialize:function(){this.render(),this.model.id&&this.initResources();var t=this;setTimeout(function(){e("#IndexContainer").attr("user_id")&&(t.$el.tooltip({selector:'*[data-toggle="tooltip"]'}),t.initUploader("song"),t.initUploader("pic"))},80)},render:function(){var t=_.template(e(i).find(this.template).html());this.$el.html(t(_.extend({},{model:this.model},{helper:n},{userId:e("#IndexContainer").attr("user_id")}))),e("#IndexContainer").empty().html(this.el)},events:{'click *[tag="submit"]':"submit",'dblclick *[tag="del"]':"del",'click *[tag="play"]':"play"},submit:function(t){var i=s.getObjFromForm(this.$el);i.resources=this.uploadedResources;var n=this.model,r=n.save(i,{wait:!0,$btn:e(t.currentTarget),success:function(e,t){if(t&&!t.error){require(["app"],function(e){e.router.navigate("#modification/"+n.id)});{new g.EditSongView({model:n})}}}}),a=this.$("select, input").closest(".form-group").find('*[tag="alert"]').children();if(a.remove(),!r){var o=0;_.each(n.validationError,function(t,i){var n=this.$('*[name="'+i+'"]').closest(".form-group").find('*[tag="alert"]').first(),r=e(s.getAlertHtml("alert-danger",t));s.renderAlert(n,r,6e4),0==o&&this.$('*[name="'+i+'"]').focus(),o++},this)}},del:function(t){this.model.destroy({wait:!0,$btn:e(t.currentTarget),success:function(e,t){t&&!t.error&&require(["app"],function(e){e.router.navigate("",{trigger:!0,replace:!0})})}})},initUploader:function(t){var r=this,a="",o="",c="",d={};if("song"==t&&(a=r.$('*[tag="song"]'),d={max_file_size:"10mb",mime_types:[{title:"Audio files",extensions:"mp3,mid,wma,wav,ogg"}]}),"pic"==t&&(a=r.$('*[tag="pic"]'),d={max_file_size:"10mb",mime_types:[{title:"Image files",extensions:"gif,jpg,jpeg,png"}]}),a){o=a.find('*[tag="upload"]'),c=a.find('*[tag="start_upload"]');var p=new l.Uploader({flash_swf_url:"/js/libs/plupload/Moxie.swf",runtimes:"flash",container:a[0],browse_button:o[0],url:"http://up.qiniu.com:80/",filters:d,multipart_params:{token:e("#IndexContainer").attr("token")},init:{PostInit:function(){c.bind("click",function(){return e(this).attr("disabled","disabled"),p.start(),!1})},FilesAdded:function(t,n){l.each(n,function(t){var n=_.template(e(i).find("#UploadTemplate").html()),s=e(n({file:t}));a.find('*[tag="upload_container"] tbody').append(s),s.find('*[tag="cancel_upload"]').bind("click",function(){p.removeFile(t),s.remove()}),t.$target=s}),c.show()},UploadProgress:function(e,t){var i=t.$target.find(".progress-bar"),n=t.percent;i.css("width",n+"%").attr("aria-valuenow",n).find("span").html(n+"%"),t.$target.find('*[tag="cancel_upload"]').attr("disabled","disabled")},Error:function(t,i){var n=e(s.getAlertHtml("alert-danger",i.message)),r=o.closest(".row").find('*[tag="alert"]').first();if(s.renderAlert(r,n,6500),i.file){var a={614:"文件名已存在"},l=a[i.status]?"（"+a[i.status]+"）":"（错误代码"+i.status+"）";i.file.$target.find(".progress-bar").find("span").html("上传失败"+l),i.file.$target.addClass("danger"),i.file.$target.find('*[tag="cancel_upload"]').removeAttr("disabled")}},BeforeUpload:function(e,t){e.settings.multipart_params.key=t.name},FileUploaded:function(e,i){i.$target.find(".progress-bar").find("span").html("上传成功"),i.$target.addClass("success"),i.$target.find('*[tag="cancel_upload"]').remove();var s={file_name:i.name,file_size:i.size,uploaded_time:n.formatDateTime(new Date,"second"),file_type:t};-1==_.indexOf(_.pluck(r.uploadedResources,"file_name"),s.file_name)&&r.uploadedResources.push(s)},UploadComplete:function(){c.removeAttr("disabled")}}});p.init()}},initResources:function(){var e=_.filter(this.model.get("resources"),function(e){return"song"==e.file_type});if(this.songResources=new r.Resources(e),this.songResources.length>0){new a.ResourcesView({collection:this.songResources,el:this.$("#SongResourcesContainer")})}var t=_.filter(this.model.get("resources"),function(e){return"pic"==e.file_type});if(this.picResources=new r.Resources(t),this.picResources.length>0){new a.ResourcesView({collection:this.picResources,el:this.$("#PicResourcesContainer")})}},play:function(t){var i=e(t.currentTarget).closest("*[resource_id]").attr("resource_id");this.model.set("song_src",this.songResources.get(i).get("file_name")),(this.viewInUse||(this.viewInUse={})).playerView&&this.viewInUse.playerView.close(),this.viewInUse.playerView=new h({model:this.model}),s.renderNowPlaying(e(t.currentTarget),"success")}}),g={ShowSongView:d,PagerView:p,SongView:g,SongsView:u,EditSongView:m,PlayerView:h};return g});