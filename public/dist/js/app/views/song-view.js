define(["jquery","backbone","text!app/templates/song-template.html","helper","utils/utils","app/models/resource-model","app/views/resource-view","app/models/meeting-model","plupload/zh_CN","utils/config","bootstrap","bootstrap-waterfall"],function(e,t,i,n,s,a,r,o,l,c){var d=t.View.extend({options:null,template:"#ShowSongTemplate",initialize:function(e){this.options=e||{},this.render()},render:function(){var t=_.template(e(i).find(this.template).html());this.$el.html(t(_.extend({},this,{app:this.options.app}))),e("#IndexContainer").empty().html(this.el)}}),p=t.View.extend({options:null,curPage:0,totalPage:0,pageSize:100,baseUrl:null,curSongsList:null,template:"#PagerTemplate",initialize:function(e){this.options=e||{},this.initPager(),this.initCurPage(),this.initBaseUrl(),this.filterSongs(),this.render()},initPager:function(){if(this.collection.length>0){var e=this.collection.length/this.pageSize;this.totalPage=e===parseInt(e,10)?e:parseInt(e,10)+1}},initCurPage:function(){var e=this.options.app.page;this.curPage=e?1>e?1:e>this.totalPage?this.totalPage:e:1},initBaseUrl:function(){var e=this.options.app.page,t=window.location.pathname;if(e)this.baseUrl=t.slice(0,t.indexOf("/p")+2);else{var i="/"==t?"p":"/p";this.baseUrl=t+i}},filterSongs:function(){var e=(this.curPage-1)*this.pageSize;this.curSongsList=_.filter(this.collection.toJSON(),function(t,i){return i>=e&&i<e+this.pageSize},this)},render:function(){require(["app/models/song-model"],e.proxy(function(t){var n=_.template(e(i).find(this.template).html());this.$el.html(n(this)),e(".PagerContainer").html(this.$el.html());new u({collection:new t.Songs(this.curSongsList)})},this))}}),u=t.View.extend({template:"#SongsTemplate",initialize:function(){this.render()},render:function(){var t=_.template(e(i).find(this.template).html());this.$el.html(t()),e("#SongsContainer").empty().html(this.el);var n=_.template(e(i).find("#waterfall-template").html());this.$(".waterfall").data("bootstrap-waterfall-template",n(_.extend({},this,{config:c},{userId:e("#IndexContainer").attr("user_id")}))).waterfall()},events:{'click *[tag="play"]':"play",'click *[tag="add"]':"add"},play:function(t){var i=e(t.currentTarget).closest("*[song_id]").attr("song_id"),n=this.collection.get(i);(this.viewInUse||(this.viewInUse={})).playerView&&this.viewInUse.playerView.close(),this.viewInUse.playerView=new g({model:n}),this.renderNowPlaying(e(t.currentTarget),"btn-success")},renderNowPlaying:function(e,t){var i=e.closest("#SongsContainer");i.find("a."+t).removeClass(t),e.addClass(t)},add:function(t){var i=e(t.currentTarget).closest("*[song_id]").attr("song_id"),n=new o.MeetingSong({song_id:i});n.save(null,{wait:!0,$btn:e(t.currentTarget)})}}),h=t.View.extend({options:null,tagName:"tr",template:"#SongTemplate",initialize:function(e){this.options=e||{},this.render()},render:function(){var t=_.template(e(i).find(this.template).html());this.$el.empty().html(t(this)),this.options.$target.append(this.el)},events:{'click *[tag="play"]':"play"},play:function(t){(this.viewInUse||(this.viewInUse={})).playerView&&this.viewInUse.playerView.close(),this.viewInUse.playerView=new g({model:this.model}),s.renderNowPlaying(e(t.currentTarget),"success")}}),g=t.View.extend({template:"#PlayerTemplate",initialize:function(){this.render()},render:function(){var t=_.template(e(i).find(this.template).html());this.$el.html(t(_.extend({},{model:this.model},{userId:e("#IndexContainer").attr("user_id")}))),e("#PlayerContainer").empty().html(this.el)},events:{'click *[tag="close"]':"close",'click *[tag="add"]':"add"},close:function(){this.clean(),this.remove()},clean:function(){var e=this.$("iframe");0!=e.length&&(e[0].src="",e[0].contentWindow.document.write(""),e[0].contentWindow.close(),e.remove()),"function"==typeof CollectGarbage&&CollectGarbage()},add:function(e){h.SongsView.prototype.add(e)}}),m=t.View.extend({uploadedResources:[],songResources:[],picResources:[],template:"#EditSongTemplate",initialize:function(){this.render(),this.model.id&&this.initResources();var t=this;setTimeout(function(){e("#IndexContainer").attr("user_id")&&(t.$el.tooltip({selector:'*[data-toggle="tooltip"]'}),t.initUploader("song"),t.initUploader("pic"))},80)},render:function(){var t=_.template(e(i).find(this.template).html());this.$el.html(t(_.extend({},{model:this.model},{helper:n},{userId:e("#IndexContainer").attr("user_id")}))),e("#IndexContainer").empty().html(this.el)},events:{'click *[tag="submit"]':"submit",'dblclick *[tag="del"]':"del",'click *[tag="play"]':"play"},submit:function(t){var i=s.getObjFromForm(this.$el);i.resources=this.uploadedResources;var n=this.model,a=n.save(i,{wait:!0,$btn:e(t.currentTarget),ajaxSync:!0,success:function(e,t){if(t&&!t.error){require(["app"],function(e){e.router.navigate("#modification/"+n.id)});{new h.EditSongView({model:n})}}}}),r=this.$("select, input").closest(".form-group").find('*[tag="alert"]').children();if(r.remove(),!a){var o=0;_.each(n.validationError,function(t,i){var n=this.$('*[name="'+i+'"]').closest(".form-group").find('*[tag="alert"]').first(),a=e(s.getAlertHtml("alert-danger",t));s.renderAlert(n,a,6e4),0==o&&this.$('*[name="'+i+'"]').focus(),o++},this)}},del:function(t){this.model.destroy({wait:!0,$btn:e(t.currentTarget),success:function(e,t){t&&!t.error&&require(["app"],function(e){e.router.navigate("",{trigger:!0,replace:!0})})}})},initUploader:function(t){var a=this,r="",o="",c="",d={};if("song"==t&&(r=a.$('*[tag="song"]'),d={max_file_size:"10mb",mime_types:[{title:"Audio files",extensions:"mp3,mid,wma,wav,ogg"}]}),"pic"==t&&(r=a.$('*[tag="pic"]'),d={max_file_size:"10mb",mime_types:[{title:"Image files",extensions:"gif,jpg,jpeg,png"}]}),r){o=r.find('*[tag="upload"]'),c=r.find('*[tag="start_upload"]');var p=new l.Uploader({flash_swf_url:"/js/libs/plupload/Moxie.swf",runtimes:"flash",container:r[0],browse_button:o[0],url:"http://up.qiniu.com:80/",filters:d,multipart_params:{token:e("#IndexContainer").attr("token")},init:{PostInit:function(){c.bind("click",function(){return e(this).attr("disabled","disabled"),p.start(),!1})},FilesAdded:function(t,n){l.each(n,function(t){var n=_.template(e(i).find("#UploadTemplate").html()),s=e(n({file:t}));r.find('*[tag="upload_container"] tbody').append(s),s.find('*[tag="cancel_upload"]').bind("click",function(){p.removeFile(t),s.remove()}),t.$target=s}),c.show()},UploadProgress:function(e,t){var i=t.$target.find(".progress-bar"),n=t.percent;i.css("width",n+"%").attr("aria-valuenow",n).find("span").html(n+"%"),t.$target.find('*[tag="cancel_upload"]').attr("disabled","disabled")},Error:function(t,i){var n=e(s.getAlertHtml("alert-danger",i.message)),a=o.closest(".row").find('*[tag="alert"]').first();if(s.renderAlert(a,n,6500),i.file){var r={614:"文件名已存在"},l=r[i.status]?"（"+r[i.status]+"）":"（错误代码"+i.status+"）";i.file.$target.find(".progress-bar").find("span").html("上传失败"+l),i.file.$target.addClass("danger"),i.file.$target.find('*[tag="cancel_upload"]').removeAttr("disabled")}},BeforeUpload:function(e,t){e.settings.multipart_params.key=t.name},FileUploaded:function(e,i){i.$target.find(".progress-bar").find("span").html("上传成功"),i.$target.addClass("success"),i.$target.find('*[tag="cancel_upload"]').remove();var s={file_name:i.name,file_size:i.size,uploaded_time:n.formatDateTime(new Date,"second"),file_type:t};-1==_.indexOf(_.pluck(a.uploadedResources,"file_name"),s.file_name)&&a.uploadedResources.push(s)},UploadComplete:function(){c.removeAttr("disabled")}}});p.init()}},initResources:function(){var e=_.filter(this.model.get("resources"),function(e){return"song"==e.file_type});if(this.songResources=new a.Resources(e),this.songResources.length>0){new r.ResourcesView({collection:this.songResources,el:this.$("#SongResourcesContainer")})}var t=_.filter(this.model.get("resources"),function(e){return"pic"==e.file_type});if(this.picResources=new a.Resources(t),this.picResources.length>0){new r.ResourcesView({collection:this.picResources,el:this.$("#PicResourcesContainer")})}},play:function(t){var i=e(t.currentTarget).closest("*[resource_id]").attr("resource_id");this.model.set("song_src",this.songResources.get(i).get("file_name")),(this.viewInUse||(this.viewInUse={})).playerView&&this.viewInUse.playerView.close(),this.viewInUse.playerView=new g({model:this.model}),s.renderNowPlaying(e(t.currentTarget),"success")}}),h={ShowSongView:d,PagerView:p,SongView:h,SongsView:u,EditSongView:m,PlayerView:g};return h});