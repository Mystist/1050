/*
 * bootstrap-waterfall
 * 
 *
 * Copyright (c) 2014 
 * Licensed under the MIT license.
 */

+function(t){function e(){this.tasks=[],this.timerId=null,this.deferred=new t.Deferred}function n(t){this.$img=t}function i(e){return this.each(function(){var n=t(this),i=n.data("mystist.waterfall"),o="object"==typeof e&&e;i||n.data("mystist.waterfall",i=new r(this,o))})}var o=o||{now:Date.now||function(){return(new Date).getTime()},throttle:function(t,e,n){var i,r,s,a=null,l=0;n||(n={});var h=function(){l=n.leading===!1?0:o.now(),a=null,s=t.apply(i,r),a||(i=r=null)};return function(){var u=o.now();l||n.leading!==!1||(l=u);var p=e-(u-l);return i=this,r=arguments,0>=p||p>e?(clearTimeout(a),a=null,l=u,s=t.apply(i,r),a||(i=r=null)):a||n.trailing===!1||(a=setTimeout(h,p)),s}}},r=function(e,n){this.$element=t(e),this.options=t.extend({},r.DEFAULTS,n),this.$pins=null,this.lefts=[],this.tops=[],this.init()};r.VERSION="0.0.1",r.DEFAULTS={},r.prototype.init=function(){this.initPins().calculatePosition().runCompass().ship()},r.prototype.initPins=function(){var e=t(t('*[type="text/bootstrap-waterfall-template"]').html());return e.each(function(){var e=t(this).find("img:eq(0)");e.length>0&&e.attr("data-bootstrap-waterfall-src",e.attr("src")).attr("src","data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==")}),this.$pins=e,this},r.prototype.calculatePosition=function(){var t=this.$pins.first().clone();this.$element.append(t);for(var e=t.outerWidth(!0),n=parseInt(this.$element.width()/e,10),i=0;n>i;i++)this.lefts.push(i*e),this.tops.push(0);return t.remove(),this},r.prototype.runCompass=function(){var t=this,e=setInterval(function(){t.$element.closest("body").length<1&&(clearInterval(e),t.destroy())},777);return this},r.prototype.prepare=function(){return t(window).on("scroll",this.sail()),this},r.prototype.sail=function(){var t=this;return o.throttle(function(){s.isWantMore.call(t)&&t.ship()},500)},r.prototype.ship=function(){var n=s.getToLoadPins.call(this),i=new e;this.hold(),i.init(n).load().run().deferred.done(t.proxy(function(){this.render(n).updateHeight().prepare()},this))},r.prototype.hold=function(){t(window).off("scroll")},r.prototype.render=function(e){var n=this;return e.each(function(){n.placePin(t(this))}),this},r.prototype.placePin=function(t){var e=this.tops.indexOf(a.m(this.tops).min),n=s.getPositionByIndex.call(this,e);t.css({position:"absolute",left:n.left,top:n.top}),this.$element.append(t),s.updatePositionByIndexAndPin.call(this,e,t)},r.prototype.updateHeight=function(){var t=this.tops.indexOf(a.m(this.tops).max);return this.$element.height(this.tops[t]),this},r.prototype.destroy=function(){this.hold(),this.$element.remove()};var s={getToLoadPins:function(){var e=8,n=this.$pins.map(function(){return t(this).find("img:eq(0)").attr("data-bootstrap-waterfall-src")?t(this):void 0});return n.slice(0,e)},isWantMore:function(){return t(window).scrollTop()+t(window).height()>a.getDocHeight()-177?!0:!1},getPositionByIndex:function(t){var e={left:this.lefts[t],top:this.tops[t]};return e},updatePositionByIndexAndPin:function(t,e){this.tops[t]+=e.outerHeight(!0)}};e.prototype.init=function(e){var i=this;return e.each(function(){var e=new n(t(this).find("img:eq(0)"));i.tasks.push(e)}),this},e.prototype.load=function(){return t.each(this.tasks,function(t,e){e.$img[0].src=e.$img.attr("data-bootstrap-waterfall-src"),e.$img.removeAttr("data-bootstrap-waterfall-src")}),this},e.prototype.run=function(){var t=this;return this.timerId=setInterval(function(){t.isDone()?t.stop():t.check()},13),this},e.prototype.isDone=function(){return 0===this.tasks.length?!0:!1},e.prototype.stop=function(){clearInterval(this.timerId),this.deferred.resolve()},e.prototype.check=function(){for(var t=0;t<this.tasks.length;t++)this.tasks[t].isLoaded()&&this.tasks.splice(t--,1)},n.prototype.isLoaded=function(){return this.$img[0].height?!0:!1};var a={m:function(t){for(var e={max:-1/0,min:1/0},n=0,i=t.length;i>n;n++)t[n]>e.max&&(e.max=t[n]),t[n]<e.min&&(e.min=t[n]);return e},getDocHeight:function(){var t=document;return Math.max(t.body.scrollHeight,t.documentElement.scrollHeight,t.body.offsetHeight,t.documentElement.offsetHeight,t.body.clientHeight,t.documentElement.clientHeight)}},l=t.fn.waterfall;t.fn.waterfall=i,t.fn.waterfall.Constructor=r,t.fn.waterfall.noConflict=function(){return t.fn.waterfall=l,this}}(jQuery);