/*
 * bootstrap-waterfall
 * 
 *
 * Copyright (c) 2014 
 * Licensed under the MIT license.
 */

+function(t){function i(i){this.$pins=i,this.tasks=[],this.timerId=null,this.deferred=new t.Deferred}function e(t){this.img=t,this.initWidth=t.width,this.initHeight=t.height}function n(i){return this.each(function(){var e=t(this),n=e.data("mystist.waterfall"),o="object"==typeof i&&i;n||e.data("mystist.waterfall",n=new s(this,o))})}var o=o||{indexOf:function(t,i,e){if(null==t)return-1;var n=0,s=t.length;if(e){if("number"!=typeof e)return n=o.sortedIndex(t,i),t[n]===i?n:-1;n=0>e?Math.max(0,s+e):e}for(;s>n;n++)if(t[n]===i)return n;return-1},now:Date.now||function(){return(new Date).getTime()},throttle:function(t,i,e){var n,s,r,a=null,h=0;e||(e={});var l=function(){h=e.leading===!1?0:o.now(),a=null,r=t.apply(n,s),a||(n=s=null)};return function(){var u=o.now();h||e.leading!==!1||(h=u);var p=i-(u-h);return n=this,s=arguments,0>=p||p>i?(clearTimeout(a),a=null,h=u,r=t.apply(n,s),a||(n=s=null)):a||e.trailing===!1||(a=setTimeout(l,p)),r}},debounce:function(t,i,e){var n,s,r,a,h,l=function(){var u=o.now()-a;i>u&&u>0?n=setTimeout(l,i-u):(n=null,e||(h=t.apply(r,s),n||(r=s=null)))};return function(){r=this,s=arguments,a=o.now();var u=e&&!n;return n||(n=setTimeout(l,i)),u&&(h=t.apply(r,s),r=s=null),h}}},s=function(i,e){this.$element=t(i),this.options=t.extend({},s.DEFAULTS,e),this.$pins=null,this.lefts=[],this.tops=[],this.perPinWidth=null,this.sail=this.sail(),this.init().compassWatch().gaugeWatch()};s.VERSION="0.0.1",s.DEFAULTS={},s.prototype.init=function(){return this.initPins().calculatePosition().ship(),this},s.prototype.initPins=function(){var i=t(this.$element.data("bootstrap-waterfall-template"));return i.each(function(){var i=t(this).find("img:eq(0)");i.length>0&&(t(this).data("bootstrap-waterfall-src",i.attr("src")),i.attr("src","data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="))}),this.$pins=i,this},s.prototype.calculatePosition=function(){var t=this.$pins.first().clone();this.$element.append(t.css("opacity",0));for(var i=t.outerWidth(!0),e=parseInt(this.$element.width()/i,10),n=[],o=[],s=0;e>s;s++)n.push(s*i),o.push(0);return this.lefts=n,this.tops=o,this.perPinWidth=t.find("img:eq(0)").width(),t.remove(),this},s.prototype.prepare=function(){return t(window).on("scroll",this.sail),this},s.prototype.sail=function(){var t=this;return o.throttle(function(){r.isWantMore.call(t)&&t.hold().ship()},500)},s.prototype.ship=function(){var e=r.getToLoadPins.call(this),n=new i(e);n.load().run().deferred.done(t.proxy(function(){this.render(e).updateHeight().prepare()},this))},s.prototype.hold=function(){return t(window).off("scroll",this.sail),this},s.prototype.render=function(i){var e=this;return i.each(function(){e.placePin(t(this))}),this},s.prototype.placePin=function(t){var i=o.indexOf(this.tops,Math.min.apply(null,this.tops)),e=r.getPosition.call(this,i);t.css({position:"absolute",left:e.left,top:e.top}),t.data("bootstrap-waterfall-pin")&&(r.setImageHeight.call(this,t),r.showImage.call(this,t),t.removeData("bootstrap-waterfall-pin")),this.$element.append(t),r.updatePosition.call(this,i,t)},s.prototype.updateHeight=function(){var t=o.indexOf(this.tops,Math.max.apply(null,this.tops));return this.$element.height(this.tops[t]),this},s.prototype.compassWatch=function(){var t=this,i=setInterval(function(){t.$element.closest("body").length<1&&(clearInterval(i),t.destroy())},777);return this},s.prototype.destroy=function(){this.hold(),this.$element.remove()},s.prototype.gaugeWatch=function(){var i=this;t(window).on("resize",o.debounce(function(){i.hold().calculatePosition().render(r.getLoadedPins.call(i)).updateHeight().prepare()},777))};var r={getToLoadPins:function(){var i=8,e=this.$pins.map(function(){return t(this).find("img").length>0&&t(this).data("bootstrap-waterfall-src")?t(this):void 0});return e.slice(0,i)},getLoadedPins:function(){var i=this.$pins.map(function(){return t(this).find("img").length>0&&!t(this).data("bootstrap-waterfall-src")?t(this):void 0});return i},isWantMore:function(){return t(window).scrollTop()+t(window).height()>a.getDocHeight()-177?!0:!1},getPosition:function(t){var i={left:this.lefts[t],top:this.tops[t]};return i},setImageHeight:function(t){var i=t.data("bootstrap-waterfall-pin"),e=this.perPinWidth*i.img.height/i.img.width;t.find("img:eq(0)").css({height:e,width:"auto"})},showImage:function(t){t.find("img:eq(0)").attr("src",t.data("bootstrap-waterfall-src")),t.removeData("bootstrap-waterfall-src")},updatePosition:function(t,i){this.tops[t]+=i.outerHeight(!0)}};i.prototype.load=function(){var i=this;return this.$pins.each(function(){var n=new Image;n.src=t(this).data("bootstrap-waterfall-src");var o=new e(n);i.tasks.push(o),t(this).data("bootstrap-waterfall-pin",o)}),this},i.prototype.run=function(){var t=this;return this.timerId=setInterval(function(){t.isDone()?t.stop():t.check()},40),this},i.prototype.isDone=function(){return 0===this.tasks.length?!0:!1},i.prototype.stop=function(){clearInterval(this.timerId),this.deferred.resolve()},i.prototype.check=function(){for(var t=0;t<this.tasks.length;t++){var i=this.tasks[t];i.isLoaded()&&this.tasks.splice(t--,1)}},e.prototype.isLoaded=function(){return this.img.width!==this.initWidth||this.img.height!==this.initHeight||this.img.width*this.img.height>1024?!0:!1};var a={getDocHeight:function(){var t=document;return Math.max(t.body.scrollHeight,t.documentElement.scrollHeight,t.body.offsetHeight,t.documentElement.offsetHeight,t.body.clientHeight,t.documentElement.clientHeight)}},h=t.fn.waterfall;t.fn.waterfall=n,t.fn.waterfall.Constructor=s,t.fn.waterfall.noConflict=function(){return t.fn.waterfall=h,this}}(jQuery);